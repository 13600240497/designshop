{#/**
*@author: 任贸华
*@date: 2018/11/24 16:31:41
*@desc: 分类添加商品SKU组件 (商品列表tab预览)
* @param {string} goodsSKU  [1,2]
*/#}
{% if options %}
    <div class="goods-tab-item tab-template layui-hide">
        <div class="goods-tab-box">
            <div class="layui-form-item">
                <div class="gs-lable-block">分类<span class="gs-tab-index"></span>
                </div>
                <div class="layui-input-block">
                    <input class="layui-input tab-item-label Unwanted"
                           type="text" value="">
                </div>
            </div>
            <div class="radio-tab-group">
                <input type="hidden" name="gsSelectLevel0" class="Unwanted">
                <input type="hidden" name="gsSelectLevel1" class="Unwanted">
                <input type="hidden" name="gsSelectLevel2" class="Unwanted">
                <div class="layui-form-item">
                    <div class="layui-input-block" style="margin-left:0;">
                        <input class="Unwanted tabItemRadio" type="radio"
                               name="skuFrom_temp" value="2" title="选品系统">
                        <input class="Unwanted tabItemRadio" type="radio"
                               name="skuFrom_temp" value="1" title="商品SKU"
                               checked="checked">
                    </div>
                </div>
                <div class="goods-hide {% if tabItem.skuFrom|default('1') == '2' %}goods-visible{% endif %}"
                     data-target="skuFrom-2">
                    <div class="select-item">
                        <label class="gs-block">一级活动信息</label>
                        <select class="gs-select-box gs-select-level0"
                                lay-ignore placeholder="请输入活动名称"
                                data-searchplaceholder="搜索分类">
                            <option value="00">请选择活动</option>
                        </select>
                    </div>
                    <div class="select-item">
                        <label class="gs-block">二级活动信息</label>
                        <select class="gs-select-box gs-select-level1"
                                lay-ignore placeholder="请输入活动名称">
                            <option value="00">请选择活动</option>
                        </select>
                    </div>
                    <div class="select-item">
                        <label class="gs-block">三级活动信息</label>
                        <select class="gs-select-box gs-select-level2"
                                lay-ignore placeholder="请输入活动名称">
                            <option value="00">请选择活动</option>
                        </select>
                    </div>
                </div>
                <div class="goods-hide {% if tabItem.skuFrom|default('1') == '1' %}goods-visible{% endif %}"
                     data-target="skuFrom-1">
                                                            <textarea class="layui-textarea Unwanted" name="goodsSKU"
                                                                      data-public-tag="true"
                                                                      placeholder="请输入商品SKU,每个SKU用英文逗号隔开.">{{ tabItem.lists }}</textarea>
                    <div class="layui-form-item tab-add-btn">
                                                                <span class="el-button el-button--primary el-button--small class-manage"
                                                                      style="float:left">商品管理</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="geshop-third-value">
														<span class="img-btn class-up">
															<i class='icon-up'></i>
															<b class="tips">上移</b>
														</span>
            <span class="img-btn class-down">
															<i class='icon-down'></i>
															<b class="tips">下移</b>
														</span>
            <span class="img-btn class-close">
															<i class='icon-delete'></i>
															<b class="tips">删除</b>
														</span>
            <span class="img-btn class-add">
															<i class='icon-add'></i>
															<b class="tips">新增</b>
														</span>
        </div>
    </div>
    <div class="goods-tab-lists radio-tab-true">
        {% for key,tabItem in options.goodsSKU|default(0..2) %}
            <div class="goods-tab-item">
                <div class="goods-tab-box">
                    <div class="layui-form-item">
                        <div class="gs-lable-block">分类<span
                                    class="gs-tab-index">{{ key+1 }}</span>
                        </div>
                        <div class="layui-input-block">
                            <input class="layui-input tab-item-label Unwanted"
                                   type="text" value="{{ tabItem.label }}">
                        </div>
                    </div>
                    <div class="radio-tab-group">
                        <input type="hidden" name="gsSelectLevel0"
                               value="{{ tabItem.ips.gsSelectLevel0 }}"
                               class="Unwanted">
                        <input type="hidden" name="gsSelectLevel1"
                               value="{{ tabItem.ips.gsSelectLevel1 }}"
                               class="Unwanted">
                        <input type="hidden" name="gsSelectLevel2"
                               value="{{ tabItem.ips.gsSelectLevel2 }}"
                               class="Unwanted">
                        <div class="layui-form-item">
                            <div class="layui-input-block"
                                 style="margin-left:0;">
                                <input class="Unwanted tabItemRadio"
                                       type="radio" name="skuFrom{{ key }}"
                                       lay-filter="skuFrom{{ key }}" value="2"
                                       title="选品系统" {% if tabItem.skuFrom == '2' %} checked="checked" {% endif %}>
                                <input class="Unwanted tabItemRadio"
                                       type="radio" name="skuFrom{{ key }}"
                                       lay-filter="skuFrom{{ key }}" value="1"
                                       title="商品SKU" {% if tabItem.skuFrom == '1' or tabItem.skuFrom is empty %} checked="checked" {% endif %}>
                            </div>
                        </div>
                        <div class="goods-hide {% if tabItem.skuFrom|default('1') == '2' %}goods-visible{% endif %}"
                             data-target="skuFrom-2">
                            <div class="select-item">
                                <label class="gs-block">一级活动信息</label>
                                <select class="gs-select-box gs-select-level0"
                                        lay-ignore placeholder="请输入活动名称"
                                        data-searchplaceholder="搜索分类">
                                    <option value="00">请选择活动</option>
                                </select>
                            </div>
                            <div class="select-item">
                                <label class="gs-block">二级活动信息</label>
                                <select class="gs-select-box gs-select-level1"
                                        lay-ignore placeholder="请输入活动名称">
                                    <option value="00">请选择活动</option>
                                </select>
                            </div>
                            <div class="select-item">
                                <label class="gs-block">三级活动信息</label>
                                <select class="gs-select-box gs-select-level2"
                                        lay-ignore placeholder="请输入活动名称">
                                    <option value="00">请选择活动</option>
                                </select>
                            </div>
                        </div>
                        <div class="goods-hide {% if tabItem.skuFrom|default('1') == '1' %}goods-visible{% endif %}"
                             data-target="skuFrom-1">
                                                                    <textarea class="layui-textarea Unwanted"
                                                                              name="goodsSKU" data-public-tag="true"
                                                                              placeholder="请输入商品SKU,每个SKU用英文逗号隔开.">{{ tabItem.lists }}</textarea>
                            <div class="layui-form-item tab-add-btn">
                                                                        <span class="el-button el-button--primary el-button--small class-manage"
                                                                              style="float:left">商品管理</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="geshop-third-value">
																<span class="img-btn class-up">
																	<i class='icon-up'></i>
																	<b class="tips">上移</b>
																</span>
                    <span class="img-btn class-down">
																	<i class='icon-down'></i>
																	<b class="tips">下移</b>
																</span>
                    <span class="img-btn class-close">
																	<i class='icon-delete'></i>
																	<b class="tips">删除</b>
																</span>
                    <span class="img-btn class-add">
																	<i class='icon-add'></i>
																	<b class="tips">新增</b>
																</span>
                </div>
            </div>
        {% endfor %}
    </div>

{% else %}
    {{ include ('@app/files/parts/common/components/argsErrors.twig') }}
{% endif %}

{#
<script>
    isRepBind({
        type: 'blur',
        delegate: $('[name=goodsSKU].Unwanted').get(0),
        callback: function () {
            $('[name=goodsSKU].Unwanted').on('blur', function () {
                var $this = $(this);
                var skuList = $(this).val();
                var skuArr = skuList.split(',');
                if (!skuList) {
                    return false;
                }
                ;
                /*去重*/
                var newArr = [];
                for (var i = 0; i < skuArr.length; i++) {
                    if (newArr.indexOf(skuArr[i]) == -1) {
                        newArr.push(skuArr[i]);
                    }
                }
                skuArr = newArr;
                skuList = newArr.toString();
                $(this).val(skuList);

                var skuList = $(this).val();
                GsManager.goods_exists(skuList).done(function (res) {
                    if (res.code !== 0) {
                        layer.confirm('' + res.message + ',是否清空', {
                            title: '提示',
                            btn: ['否', '是'],
                            area: '420px',
                            icon: 3,
                            skin: 'element-ui-dialog-class'
                        }, function (index) {
                            layui.layer.close(index)
                        }, function (index) {
                            var delSkuArr = res.message.split(' ')[1].split(','),
                                skuListArr = skuList.split(','),
                                newSku = '';
                            delSkuArr.forEach(function (delItem) {
                                skuListArr.forEach(function (skuItem, skuIndex) {
                                    if (delItem == skuItem) {
                                        skuListArr.splice(skuIndex, 1)
                                    }
                                })
                            });
                            newSku = skuListArr.toString();
                            $this.val(newSku);
                            layer.close(index);
                        })
                    }
                });
            });
        }
    });


    /*radio list render*/
    function ipsRadioInit() {
        $('.goods-form-table .goods-tab-lists .radio-tab-group').each(function (index, element) {
            var $radio = $(element).find('.tabItemRadio');
            var $radioName = 'skuFrom' + index;
            $radio.attr({'name': $radioName, 'lay-filter': $radioName});
            if ($('input[name=' + $radioName + ']:checked').length === 0) {
                $('input[name=' + $radioName + '][value=1]').prop('checked', true)
            }

            var $tr = $(element).closest('tr');
            var skuFrom = $('input[name=' + $radioName + ']:checked').val();
            if (skuFrom == '2') {
                $tr.find('.class-manage').addClass('layui-hide');
            } else {
                $tr.find('.class-manage').removeClass('layui-hide');
            }


            layui.form.render();
            layui.form.on('radio(' + $radioName + ')', function (data) {
                var value = Number(data.value);
                $(element).find("[data-target=skuFrom-" + value + "]").addClass('goods-visible').siblings().removeClass('goods-visible');
                if (value == '2') {
                    $tr.find('.class-manage').addClass('layui-hide');
                } else {
                    $tr.find('.class-manage').removeClass('layui-hide');
                }
            })
        });

    }

    function tabIndexInit() {

    }

    $(function () {
        ipsRadioInit();
        GsSelect.initSelectFirstGroup();
        $('.radio-tab-true').find('.radio-tab-group').each(function (index, element) {
            /*GsSelect.initSelectFirst($(element));*/

            $(".gs-select-box", $(element)).each(function (index) {
                var val = $('input[name=gsSelectLevel' + index + ']', $(element)).val();
                if (val) {
                    $(this).val(val);
                }

            });
        });

        var $goodsTable = $('.goods-form-table');
        $("#component_form").off('click');

        function addOne() {
            var clone = $('.tab-template', $goodsTable).clone();
            clone.removeClass('tab-template layui-hide');
            $('.goods-tab-lists', $goodsTable).append(clone);
            ipsRadioInit();
            GsSelect.initSelect($('.radio-tab-true .goods-tab-item:last'));
            GsSelect.initSelectFirst($('.radio-tab-true .goods-tab-item:last'));
        }

        function initItemIndex() {
            $('.goods-tab-lists').find('.goods-tab-item').each(function (index) {
                var $this = $(this);
                $this.find('.gs-tab-index').text(index + 1);
            })
        }

        /*删除分类 */

        isRepBind({
            delegate: $("#component_form").get(0),
            selector: '.goods-form-table .class-close',
            callback: function () {
                $("#component_form").on('click', '.goods-form-table .class-close', function () {
                    var $this = $('this');
                    $tr = $(this).parents('.goods-tab-item:eq(0)');
                    var formItemNum = $(".goods-form-table .goods-tab-box").length;
                    if (formItemNum <= 2) {
                        layer.msg('该数据无法删除');
                    } else {
                        var itemTab = $tr.find('input[type="radio"].tabItemRadio:checked').val();
                        if (itemTab == '1') {
                            /* 商品SKU */
                            var isValue = !!$tr.find("textarea").val();
                        } else {
                            /* 选品系统 */
                            var gsSelectLevel0 = $tr.find('input[name=gsSelectLevel0]').val(),
                                gsSelectLevel1 = $tr.find('input[name=gsSelectLevel1]').val(),
                                gsSelectLevel2 = $tr.find('input[name=gsSelectLevel2]').val();
                            var isValue = gsSelectLevel0 || gsSelectLevel1 || gsSelectLevel2;
                        }
                        if (isValue) {
                            layer.confirm('当前数据删除将无法恢复，确定是否删除？', {icon: 3, title: '提示'}, function (index) {
                                $tr.remove();
                                layer.close(index);
                            })
                        } else {
                            $tr.remove();
                        }
                    }

                });
            }
        });

        /*新增分类 */

        isRepBind({
            type: 'click.addTab',
            delegate: $("#component_form").get(0),
            selector: '.goods-tab-lists .class-add',
            callback: function () {
                $("#component_form").on('click.addTab', '.goods-tab-lists .class-add', function (e) {
                    e.stopPropagation();
                    addOne();
                    initItemIndex();
                });
            }
        });
        /*        $('#gs_tab_add').on('click', function () {
                    var clone = $('.tab-template', $goodsTable).clone();
                    clone.removeClass('tab-template layui-hide');
                    $('.goods-tab-lists', $goodsTable).append(clone);
                    ipsRadioInit();
                    GsSelect.initSelect($('.radio-tab-true tr:last'));
                    GsSelect.initSelectFirst($('.radio-tab-true tr:last'));
                });*/
        /*移动分类 */

        isRepBind({
            delegate: $("#component_form").get(0),
            selector: '.goods-form-table .class-down',
            callback: function () {
                $("#component_form").on('click', '.goods-form-table .class-down', function (e) {
                    var $this = $('this'),
                        $tr = $(this).parents('.goods-tab-item:eq(0)'),
                        $trNext = $tr.next();
                    if (0 != $trNext.length) {
                        $trNext.after($tr);
                    }
                    initItemIndex();

                });
            }
        });


        isRepBind({
            delegate: $("#component_form").get(0),
            selector: '.goods-form-table .class-up',
            callback: function () {
                $("#component_form").on('click', '.goods-form-table .class-up', function (e) {
                    var $this = $('this'),
                        $tr = $(this).parents('.goods-tab-item:eq(0)'),
                        $trPrev = $tr.prev();
                    if (0 != $trPrev.length) {
                        $trPrev.before($tr);
                    }
                    initItemIndex();
                });
            }
        });


    })


</script>#}
